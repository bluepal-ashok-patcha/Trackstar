name: Docker Build and Push

# Trigger: Wait for 'Backend CI' to finish on the 'main' branch
on:
  workflow_run:
    workflows: ["Backend CI"]
    branches: [main]
    types:
      - completed

jobs:
  docker:
    runs-on: ubuntu-latest
    # Condition: Only run if the tests actually PASSED
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Safety: Checkout the specific commit that passed the tests
          ref: ${{ github.event.workflow_run.head_sha }}
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Docker images
        run: |
          DOCKER_USER=${{ secrets.DOCKERHUB_USERNAME }}

          # 1. Eureka Server
          docker build -f backend/eureka-server/Dockerfile -t $DOCKER_USER/eureka-server:latest ./backend
          docker push $DOCKER_USER/eureka-server:latest

          # 2. API Gateway
          docker build -f backend/api-gateway/Dockerfile -t $DOCKER_USER/api-gateway:latest ./backend
          docker push $DOCKER_USER/api-gateway:latest
          
          # 3. Auth Service
          docker build -f backend/auth-service/Dockerfile -t $DOCKER_USER/auth-service:latest ./backend
          docker push $DOCKER_USER/auth-service:latest
          
          # 4. Fleet Service
          docker build -f backend/fleet-service/Dockerfile -t $DOCKER_USER/fleet-service:latest ./backend
          docker push $DOCKER_USER/fleet-service:latest
